{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///D:/agntha%20Project/next-url-shortener/lib/db.ts"],"sourcesContent":["import fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nexport type Link = {\r\n  code: string;\r\n  url: string;\r\n  createdAt: string;\r\n  clicks: number;\r\n  lastClicked?: string | null;\r\n};\r\n\r\nconst DATA_FILE = path.join(process.cwd(), \"data\", \"links.json\");\r\n\r\n// in-memory fallback store (used when file writes are not allowed)\r\nconst inMemory = new Map<string, Link>();\r\nlet persistenceAvailable = true;\r\n\r\nasync function readLinks(): Promise<Link[]> {\r\n  if (!persistenceAvailable) {\r\n    return Array.from(inMemory.values());\r\n  }\r\n\r\n  try {\r\n    const raw = await fs.readFile(DATA_FILE, \"utf8\");\r\n    const arr = JSON.parse(raw) as Link[];\r\n    // populate in-memory cache for fast access\r\n    inMemory.clear();\r\n    for (const l of arr) inMemory.set(l.code, l);\r\n    return arr;\r\n  } catch (e: any) {\r\n    if (e.code === \"ENOENT\") {\r\n      return Array.from(inMemory.values());\r\n    }\r\n    console.error(\"readLinks error, disabling persistence:\", e);\r\n    persistenceAvailable = false;\r\n    return Array.from(inMemory.values());\r\n  }\r\n}\r\n\r\nasync function writeLinks(links: Link[]) {\r\n  if (!persistenceAvailable) {\r\n    // update memory only\r\n    inMemory.clear();\r\n    for (const l of links) inMemory.set(l.code, l);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await fs.mkdir(path.dirname(DATA_FILE), { recursive: true });\r\n    await fs.writeFile(DATA_FILE, JSON.stringify(links, null, 2), \"utf8\");\r\n    // keep in-memory cache in sync\r\n    inMemory.clear();\r\n    for (const l of links) inMemory.set(l.code, l);\r\n  } catch (e) {\r\n    console.error(\"writeLinks failed, disabling persistence and using in-memory:\", e);\r\n    persistenceAvailable = false;\r\n    // fallback to memory\r\n    inMemory.clear();\r\n    for (const l of links) inMemory.set(l.code, l);\r\n  }\r\n}\r\n\r\nexport async function listLinks(): Promise<Link[]> {\r\n  return readLinks();\r\n}\r\n\r\nexport async function getLinkByCode(code: string): Promise<Link | null> {\r\n  // quick memory check first\r\n  const cached = inMemory.get(code);\r\n  if (cached) return cached;\r\n  const links = await readLinks();\r\n  const found = links.find((l) => l.code === code) ?? null;\r\n  if (found) inMemory.set(found.code, found);\r\n  return found;\r\n}\r\n\r\nexport async function getStatsByCode(code: string): Promise<{ clicks: number; lastClicked?: string | null } | null> {\r\n  const link = await getLinkByCode(code);\r\n  if (!link) return null;\r\n  return { clicks: link.clicks, lastClicked: link.lastClicked ?? null };\r\n}\r\n\r\nexport async function createLink(code: string, url: string): Promise<Link> {\r\n  const links = await readLinks();\r\n  if (links.find((l) => l.code === code)) {\r\n    const err: any = new Error(\"Code exists\");\r\n    err.code = \"EXISTS\";\r\n    throw err;\r\n  }\r\n  const now = new Date().toISOString();\r\n  const link: Link = { code, url, createdAt: now, clicks: 0, lastClicked: null };\r\n  links.push(link);\r\n  await writeLinks(links);\r\n  return link;\r\n}\r\n\r\nexport async function deleteLink(code: string): Promise<boolean> {\r\n  const links = await readLinks();\r\n  const filtered = links.filter((l) => l.code !== code);\r\n  if (filtered.length === links.length) return false;\r\n  await writeLinks(filtered);\r\n  return true;\r\n}\r\n\r\nexport async function incrementClick(code: string): Promise<void> {\r\n  const links = await readLinks();\r\n  const i = links.findIndex((l) => l.code === code);\r\n  if (i === -1) return;\r\n  links[i].clicks = (links[i].clicks || 0) + 1;\r\n  links[i].lastClicked = new Date().toISOString();\r\n  await writeLinks(links);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///D:/agntha%20Project/next-url-shortener/app/%5Bcode%5D/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { getLinkByCode, incrementClick } from \"@/lib/db\";\r\n\r\nexport async function GET(request: Request, context: any) {\r\n  // context.params may be a Promise in some Next versions/tools â€” use any to avoid type-check mismatch\r\n  const code = (context?.params && (await Promise.resolve(context.params)).code) || undefined;\r\n  if (!code) {\r\n    return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n  }\r\n\r\n  const link = await getLinkByCode(String(code));\r\n  if (!link) {\r\n    return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n  }\r\n\r\n  // increment click count (fire-and-forget is fine, but await to persist)\r\n  try {\r\n    await incrementClick(String(code));\r\n  } catch {\r\n    /* ignore increment failures */\r\n  }\r\n\r\n  return NextResponse.redirect(link.url);\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAgB,EAAE,OAAY;IACtD,qGAAqG;IACrG,MAAM,OAAO,AAAC,SAAS,UAAU,CAAC,MAAM,QAAQ,OAAO,CAAC,QAAQ,MAAM,CAAC,EAAE,IAAI,IAAK;IAClF,IAAI,CAAC,MAAM;QACT,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IAEA,MAAM,OAAO,MAAM,IAAA,4HAAa,EAAC,OAAO;IACxC,IAAI,CAAC,MAAM;QACT,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IAEA,wEAAwE;IACxE,IAAI;QACF,MAAM,IAAA,6HAAc,EAAC,OAAO;IAC9B,EAAE,OAAM;IACN,6BAA6B,GAC/B;IAEA,OAAO,gJAAY,CAAC,QAAQ,CAAC,KAAK,GAAG;AACvC"}}]
}